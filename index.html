<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ごみ収集カレンダー</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no, viewport-fit=cover">
  
  <meta name="apple-mobile-web-app-capable" content="yes">
  <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
  <meta name="theme-color" content="#f8fafc">

  <!-- PWA 用（可选）-->
  <link rel="manifest" href="manifest.json">

  <link rel="apple-touch-icon" href="icon.png">
  <link rel="icon" type="image/png" href="icon.png">

  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

  <style>
    :root {
      --primary: #3b82f6;
      --bg-body: #f8fafc;
      --bg-card: #ffffff;
      --text-main: #1e293b;
      --text-sub: #64748b;
      --border: #e2e8f0;
    }

    * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
    
    body {
      font-family: -apple-system, BlinkMacSystemFont, "Hiragino Sans", "Hiragino Kaku Gothic ProN", Meiryo, sans-serif;
      background-color: var(--bg-body);
      color: var(--text-main);
      margin: 0;
      padding: env(safe-area-inset-top) 12px 20px 12px;
      min-height: 100vh;
    }

    /* === 顶部导航 === */
    .header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 10px;
      padding: 0 4px;
    }

    .month-nav {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .month-title {
      font-size: 20px;
      font-weight: 800;
      letter-spacing: 0.05em;
      white-space: nowrap;
    }

    .btn-icon {
      width: 36px;
      height: 36px;
      border-radius: 50%;
      border: 1px solid var(--border);
      background: #ffffff;
      box-shadow: 0 1px 2px rgba(0,0,0,0.05);
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-main);
      cursor: pointer;
      transition: all 0.2s;
    }
    .btn-icon:active { transform: scale(0.92); background: #f1f5f9; }

    .btn-today {
      font-size: 12px;
      font-weight: 600;
      width: auto;
      padding: 0 12px;
      border-radius: 20px;
    }

    .btn-settings {
      background: var(--text-main);
      color: white;
      padding: 8px 16px;
      border-radius: 20px;
      font-size: 14px;
      font-weight: 600;
      border: none;
      box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
      cursor: pointer;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    .btn-settings:active { transform: scale(0.96); }

    /* === 明日提醒横幅 === */
    .tomorrow-banner {
      margin: 0 0 16px;
      padding: 12px 16px;
      border-radius: 16px;
      background: linear-gradient(135deg, #f59e0b, #ef4444);
      color: #fff;
      font-size: 14px;
      font-weight: 600;
      display: flex;
      align-items: flex-start;
      gap: 12px;
      box-shadow: 0 4px 12px rgba(239, 68, 68, 0.25);
      animation: slideDown 0.3s ease-out;
    }
    @keyframes slideDown {
      from { opacity: 0; transform: translateY(-10px); }
      to { opacity: 1; transform: translateY(0); }
    }
    .tomorrow-banner i {
      font-size: 18px;
      margin-top: 2px;
    }
    .tomorrow-banner .banner-content {
      display: flex;
      flex-direction: column;
    }
    .tomorrow-banner small {
      font-size: 11px;
      opacity: 0.9;
      font-weight: 400;
      margin-top: 2px;
    }

    /* === 日历主体 === */
    .calendar-container {
      background: var(--bg-card);
      border-radius: 16px;
      box-shadow: 0 4px 20px rgba(0,0,0,0.05);
      border: 1px solid rgba(255,255,255,0.5);
      overflow-x: auto;
      -webkit-overflow-scrolling: touch;
    }

    .calendar-inner {
      min-width: 600px;
    }

    .weekdays {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      background: #f8fafc;
      border-bottom: 1px solid var(--border);
    }
    .weekdays div {
      padding: 10px 0;
      text-align: center;
      font-size: 12px;
      font-weight: 700;
      color: var(--text-sub);
    }
    .weekdays div.sun { color: #ef4444; }
    .weekdays div.sat { color: #3b82f6; }

    .days-grid {
      display: grid;
      grid-template-columns: repeat(7, 1fr);
      auto-rows: minmax(85px, auto); 
    }

    .day-cell {
      border-right: 1px solid var(--border);
      border-bottom: 1px solid var(--border);
      padding: 4px;
      position: relative;
      background: white;
      cursor: pointer;
      display: flex;
      flex-direction: column;
      transition: background 0.1s;
    }
    .day-cell:nth-child(7n) { border-right: none; }
    .day-cell:active { background: #f1f5f9; }

    .day-cell.today {
      background: #fffbeb;
      position: relative;
    }
    .day-cell.today::after {
      content: '';
      position: absolute;
      inset: 0;
      border: 2px solid #fbbf24;
      pointer-events: none;
      z-index: 1;
    }

    .date-num {
      text-align: center;
      font-size: 14px;
      font-weight: 600;
      margin-bottom: 4px;
      color: var(--text-main);
    }
    .day-cell.sun .date-num { color: #ef4444; }
    .day-cell.sat .date-num { color: #3b82f6; }
    .day-cell.other-month { background: #fcfcfc; opacity: 0.5; pointer-events: none; }

    .labels-container {
      display: flex;
      flex-direction: column;
      gap: 2px;
      flex: 1;
    }
    .mini-label {
      font-size: 10px;
      padding: 2px 4px;
      border-radius: 4px;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      font-weight: 500;
      line-height: 1.2;
    }

    .legend {
      display: flex;
      flex-wrap: wrap;
      gap: 8px;
      margin-top: 16px;
      justify-content: center;
      padding-bottom: 20px;
    }
    .legend-item {
      display: flex;
      align-items: center;
      gap: 4px;
      font-size: 11px;
      color: var(--text-sub);
      background: white;
      padding: 4px 8px;
      border-radius: 12px;
      border: 1px solid var(--border);
    }
    .legend-dot { width: 8px; height: 8px; border-radius: 50%; }

    /* モーダル共通 */
    .modal-overlay {
      position: fixed;
      inset: 0;
      background: rgba(0,0,0,0.4);
      backdrop-filter: blur(4px);
      z-index: 100;
      opacity: 0;
      visibility: hidden;
      transition: all 0.25s ease;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    .modal-overlay.active { opacity: 1; visibility: visible; }

    .modal-card {
      background: white;
      width: 90%;
      max-width: 600px;
      max-height: 85vh;
      border-radius: 20px;
      box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.1);
      display: flex;
      flex-direction: column;
      transform: scale(0.95);
      transition: all 0.25s cubic-bezier(0.34, 1.56, 0.64, 1);
      overflow: hidden;
    }
    .modal-overlay.active .modal-card { transform: scale(1); }

    .modal-header {
      padding: 16px 20px;
      border-bottom: 1px solid var(--border);
      display: flex;
      justify-content: space-between;
      align-items: center;
      background: rgba(255,255,255,0.9);
      backdrop-filter: blur(10px);
      position: sticky;
      top: 0;
      z-index: 10;
    }
    .modal-title { font-size: 18px; font-weight: 700; }
    .modal-close-btn {
      background: #f1f5f9;
      border: none;
      width: 32px;
      height: 32px;
      border-radius: 50%;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      color: var(--text-sub);
    }

    .modal-body {
      padding: 16px;
      overflow-y: auto;
      overscroll-behavior: contain;
    }

    .modal-footer {
      padding: 12px 20px;
      border-top: 1px solid var(--border);
      background: #f8fafc;
      display: flex;
      justify-content: flex-end;
      gap: 10px;
    }

    /* 設定画面用 */
    .settings-list { display: flex; flex-direction: column; gap: 16px; }

    .setting-group {
      background: white;
      border: 1px solid var(--border);
      border-radius: 12px;
      padding: 12px;
    }
    .setting-header {
      display: flex;
      align-items: center;
      gap: 8px;
      margin-bottom: 10px;
      font-weight: 700;
      font-size: 15px;
      justify-content: space-between;
    }
    .setting-title {
      flex: 1;
      display: flex;
      align-items: center;
      gap: 8px;
    }
    .setting-indicator {
      width: 4px; height: 16px; border-radius: 2px;
    }
    .delete-type-btn {
      border: none;
      background: transparent;
      color: var(--text-sub);
      cursor: pointer;
      padding: 4px;
      border-radius: 50%;
    }

    /* 無効バッジ */
    .badge-muted {
      font-size: 10px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #e5e7eb;
      color: #6b7280;
    }

    .mode-selector {
      display: flex;
      background: #f1f5f9;
      padding: 4px;
      border-radius: 8px;
      margin-bottom: 12px;
    }
    .mode-option {
      flex: 1;
      text-align: center;
      padding: 6px;
      font-size: 12px;
      border-radius: 6px;
      cursor: pointer;
      color: var(--text-sub);
      transition: all 0.2s;
      font-weight: 500;
    }
    .mode-option.active {
      background: white;
      color: var(--text-main);
      box-shadow: 0 1px 2px rgba(0,0,0,0.1);
      font-weight: 700;
    }

    .week-selector, .nth-selector {
      display: flex;
      gap: 6px;
      justify-content: space-between;
    }
    .toggle-btn {
      flex: 1;
      height: 36px;
      display: flex;
      align-items: center;
      justify-content: center;
      border: 1px solid var(--border);
      background: white;
      border-radius: 8px;
      font-size: 12px;
      font-weight: 500;
      color: var(--text-sub);
      cursor: pointer;
      transition: all 0.15s;
    }
    .toggle-btn.active {
      background: var(--text-main);
      color: white;
      border-color: var(--text-main);
    }
    
    .hidden { display: none !important; }

    .btn-save {
      background: var(--text-main); color: white;
      padding: 10px 24px; border-radius: 99px;
      border: none; font-weight: 600; cursor: pointer;
    }
    .btn-reset {
      background: transparent; color: #ef4444;
      padding: 10px 16px; border-radius: 99px;
      border: none; font-size: 13px; cursor: pointer;
    }

    .btn-add-type {
      background: #3b82f6;
      color: white;
      padding: 8px 14px;
      border-radius: 999px;
      border: none;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 6px;
      cursor: pointer;
      margin-bottom: 12px;
    }

    /* 詳細画面用 */
    .detail-date { font-size: 20px; font-weight: 800; margin-bottom: 4px; }
    .detail-meta { color: var(--text-sub); font-size: 13px; margin-bottom: 16px; }
    
    .detail-item {
      display: flex;
      align-items: center;
      padding: 12px;
      border-radius: 12px;
      margin-bottom: 8px;
      background: #f8fafc;
      border: 1px solid transparent;
    }
    .detail-icon {
      width: 40px; height: 40px;
      border-radius: 10px;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 18px;
      margin-right: 12px;
    }
    .detail-name { font-weight: 700; font-size: 15px; }
    .detail-empty {
      text-align: center; padding: 30px; color: var(--text-sub);
      background: #f8fafc; border-radius: 12px; border: 1px dashed var(--border);
    }

    @media (max-width: 480px) {
      body {
        padding-left: 8px;
        padding-right: 8px;
      }
      .calendar-inner { min-width: 560px; }
      .days-grid { auto-rows: minmax(72px, auto); }
      .mini-label { font-size: 9px; }
      .date-num { font-size: 13px; }
    }
  </style>
</head>
<body>

<div class="header">
  <div class="month-nav">
    <button class="btn-icon" id="prevMonth" aria-label="前の月へ"><i class="fa-solid fa-chevron-left"></i></button>
    <div class="month-title" id="monthLabel"></div>
    <button class="btn-icon btn-today" id="todayBtn" title="今日に戻る">今日</button>
    <button class="btn-icon" id="nextMonth" aria-label="次の月へ"><i class="fa-solid fa-chevron-right"></i></button>
  </div>
  <button class="btn-settings" id="openSettings">
    <i class="fa-solid fa-sliders"></i> 設定
  </button>
</div>

<div id="bannerContainer"></div>

<div class="calendar-container">
  <div class="calendar-inner">
    <div class="weekdays">
      <div class="sun">日</div><div>月</div><div>火</div><div>水</div><div>木</div><div>金</div><div class="sat">土</div>
    </div>
    <div class="days-grid" id="calendarGrid"></div>
  </div>
</div>

<div class="legend" id="legendContainer"></div>

<div class="modal-overlay" id="detailModal">
  <div class="modal-card">
    <div class="modal-header">
      <div class="modal-title">収集内容</div>
      <button class="modal-close-btn" id="closeDetail"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="modal-body">
      <div class="detail-date" id="detailDateStr"></div>
      <div class="detail-meta" id="detailMetaStr"></div>
      <div id="detailList"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-save" style="width:100%" id="okDetail">閉じる</button>
    </div>
  </div>
</div>

<div class="modal-overlay" id="settingsModal">
  <div class="modal-card">
    <div class="modal-header">
      <div class="modal-title">収集ルール設定</div>
      <button class="modal-close-btn" id="closeSettings"><i class="fa-solid fa-xmark"></i></button>
    </div>
    <div class="modal-body">
      <button class="btn-add-type" id="addCategory">
        <i class="fa-solid fa-plus"></i> 分類を追加
      </button>
      <div class="settings-list" id="settingsList"></div>
    </div>
    <div class="modal-footer">
      <button class="btn-reset" id="resetSettings">初期化</button>
      <button class="btn-save" id="saveSettings">保存して閉じる</button>
    </div>
  </div>
</div>

<script>
  const COLOR_PALETTE = [
    { bgColor: "#fee2e2", textColor: "#991b1b", color: "#ef4444" },
    { bgColor: "#fef3c7", textColor: "#92400e", color: "#f59e0b" },
    { bgColor: "#dbeafe", textColor: "#1d4ed8", color: "#3b82f6" },
    { bgColor: "#dcfce7", textColor: "#166534", color: "#22c55e" },
    { bgColor: "#e0e7ff", textColor: "#3730a3", color: "#6366f1" },
    { bgColor: "#fae8ff", textColor: "#86198f", color: "#e879f9" },
    { bgColor: "#f3e8ff", textColor: "#6b21a8", color: "#a855f7" },
    { bgColor: "#e0f2fe", textColor: "#075985", color: "#0ea5e9" }
  ];

  const DEFAULT_TYPES = [
    { id: "burnable",    label: "燃やすごみ",       color: "#ef4444", bgColor: "#fee2e2", textColor: "#991b1b", icon: "fa-fire" },
    { id: "nonburnable", label: "燃やさないごみ",   color: "#374151", bgColor: "#f3f4f6", textColor: "#374151", icon: "fa-battery-full" },
    { id: "plastic",     label: "プラスチック",     color: "#1d4ed8", bgColor: "#dbeafe", textColor: "#1e40af", icon: "fa-bottle-water" },
    { id: "paper",       label: "古紙・びん・缶",   color: "#a16207", bgColor: "#fef9c3", textColor: "#854d0e", icon: "fa-newspaper" },
    { id: "pet",         label: "ペットボトル",     color: "#15803d", bgColor: "#dcfce7", textColor: "#166534", icon: "fa-recycle" },
    { id: "tray",        label: "食品トレイ",       color: "#4338ca", bgColor: "#e0e7ff", textColor: "#3730a3", icon: "fa-utensils" },
    { id: "cloth",       label: "古布",             color: "#a21caf", bgColor: "#fae8ff", textColor: "#86198f", icon: "fa-shirt" }
  ];

  const DEFAULT_RULES = {
    burnable:    { mode: "weekly", weekdays: [3, 6], nth: [] },
    nonburnable: { mode: "nth",    weekdays: [1],    nth: [1, 3] },
    plastic:     { mode: "weekly", weekdays: [2],    nth: [] },
    paper:       { mode: "nth",    weekdays: [2],    nth: [2, 4] },
    pet:         { mode: "weekly", weekdays: [5],    nth: [] },
    tray:        { mode: "weekly", weekdays: [5],    nth: [] },
    cloth:       { mode: "weekly", weekdays: [5],    nth: [] }
  };

  const STORAGE_KEY = "gomi-app-v5";

  let types = [];
  let rules = {};
  let currentDate = new Date();
  let renderTimer = null;

  // 今日（00:00:00）を取得
  function getToday() {
    const d = new Date();
    d.setHours(0, 0, 0, 0);
    return d;
  }

  // 明日（00:00:00）
  function getTomorrow() {
    const t = getToday();
    t.setDate(t.getDate() + 1);
    return t;
  }

  function createDefaultState() {
    return {
      types: JSON.parse(JSON.stringify(DEFAULT_TYPES)),
      rules: JSON.parse(JSON.stringify(DEFAULT_RULES))
    };
  }

  function loadState() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (!raw) return createDefaultState();
      const parsed = JSON.parse(raw);

      let loadedTypes = Array.isArray(parsed.types) && parsed.types.length
        ? parsed.types
        : DEFAULT_TYPES;
      loadedTypes = JSON.parse(JSON.stringify(loadedTypes));

      let loadedRules = parsed.rules && typeof parsed.rules === "object"
        ? parsed.rules
        : DEFAULT_RULES;
      loadedRules = JSON.parse(JSON.stringify(loadedRules));

      loadedTypes.forEach(t => {
        if (!loadedRules[t.id]) {
          loadedRules[t.id] = { mode: "off", weekdays: [], nth: [] };
        }
      });

      return { types: loadedTypes, rules: loadedRules };
    } catch {
      return createDefaultState();
    }
  }

  function persistState() {
    localStorage.setItem(STORAGE_KEY, JSON.stringify({ types, rules }));
  }

  function checkRule(date, rule) {
    if (!rule || rule.mode === "off") return false;
    const w = date.getDay();
    if (!rule.weekdays.includes(w)) return false;

    if (rule.mode === "weekly") return true;

    if (rule.mode === "nth") {
      const nth = Math.floor((date.getDate() - 1) / 7) + 1;
      return rule.nth.includes(nth);
    }
    return false;
  }

  function getGarbageList(date) {
    return types.filter(t => checkRule(date, rules[t.id]));
  }

  (function initState() {
    const state = loadState();
    types = state.types;
    rules = state.rules;
  })();

  function init() {
    renderCalendar();
    renderLegend();
    renderSettingsUI();

    document.getElementById("prevMonth").onclick = () => changeMonth(-1);
    document.getElementById("nextMonth").onclick = () => changeMonth(1);
    
    document.getElementById("todayBtn").onclick = () => {
      currentDate = new Date();
      renderCalendar();
    };

    document.getElementById("openSettings").onclick = () => {
      renderSettingsUI();
      toggleModal("settingsModal", true);
    };
    document.getElementById("closeSettings").onclick = () => toggleModal("settingsModal", false);
    document.getElementById("saveSettings").onclick = () => {
      persistState();
      renderCalendar();
      renderLegend();
      toggleModal("settingsModal", false);
    };
    document.getElementById("resetSettings").onclick = resetAll;
    document.getElementById("addCategory").onclick = addCategory;

    document.getElementById("closeDetail").onclick = () => toggleModal("detailModal", false);
    document.getElementById("okDetail").onclick    = () => toggleModal("detailModal", false);

    document.querySelectorAll(".modal-overlay").forEach(el => {
      el.addEventListener("click", e => {
        if (e.target === el) toggleModal(el.id, false);
      });
    });

    document.addEventListener("keydown", e => {
      if (e.key === "Escape") {
        toggleModal("detailModal", false);
        toggleModal("settingsModal", false);
      }
    });
  }

  // 月変更 + 軽い防抖
  function changeMonth(delta) {
    currentDate.setMonth(currentDate.getMonth() + delta);
    if (renderTimer) cancelAnimationFrame(renderTimer);
    renderTimer = requestAnimationFrame(() => {
      renderCalendar();
    });
  }

  function renderCalendar() {
    const y = currentDate.getFullYear();
    const m = currentDate.getMonth();
    document.getElementById("monthLabel").textContent = `${y}年 ${m + 1}月`;

    const firstDay = new Date(y, m, 1);
    const lastDay = new Date(y, m + 1, 0);
    const startWeek = firstDay.getDay();
    const totalDays = lastDay.getDate();
    const todayObj = getToday();

    const grid = document.getElementById("calendarGrid");
    grid.innerHTML = "";

    for (let i = 0; i < startWeek; i++) {
      const cell = document.createElement("div");
      cell.className = "day-cell other-month";
      grid.appendChild(cell);
    }

    for (let d = 1; d <= totalDays; d++) {
      const date = new Date(y, m, d);
      date.setHours(0, 0, 0, 0); // 時分秒を0に揃える

      const cell = document.createElement("div");
      cell.className = "day-cell";

      const w = date.getDay();
      if (w === 0) cell.classList.add("sun");
      if (w === 6) cell.classList.add("sat");

      if (date.getTime() === todayObj.getTime()) {
        cell.classList.add("today");
      }

      const num = document.createElement("div");
      num.className = "date-num";
      num.textContent = d;
      cell.appendChild(num);

      const container = document.createElement("div");
      container.className = "labels-container";

      const list = getGarbageList(date);
      list.forEach(g => {
        const label = document.createElement("div");
        label.className = "mini-label";
        label.textContent = g.label;
        label.style.background = g.bgColor;
        label.style.color = g.textColor;
        container.appendChild(label);
      });
      cell.appendChild(container);

      cell.addEventListener("click", () => openDetail(date, list));
      grid.appendChild(cell);
    }

    const cellsSoFar = startWeek + totalDays;
    const remainder = cellsSoFar % 7;
    if (remainder !== 0) {
      const blanks = 7 - remainder;
      for (let i = 0; i < blanks; i++) {
        const cell = document.createElement("div");
        cell.className = "day-cell other-month";
        grid.appendChild(cell);
      }
    }

    renderTomorrowBanner(); 
  }

  // 明日のごみ出しバナー表示
  function renderTomorrowBanner() {
    const container = document.getElementById("bannerContainer");
    container.innerHTML = "";

    const tomorrow = getTomorrow();
    const list = getGarbageList(tomorrow);
    if (!list.length) return;

    const banner = document.createElement("div");
    banner.className = "tomorrow-banner";

    const labels = list.map(t => t.label).join("・");
    banner.innerHTML = `
      <i class="fa-solid fa-bell"></i>
      <div class="banner-content">
        <div>明日（${tomorrow.getMonth()+1}月${tomorrow.getDate()}日）は <strong>${labels}</strong> の日です。</div>
        <small>出し忘れにご注意ください</small>
      </div>
    `;

    container.appendChild(banner);
  }

  function renderLegend() {
    const el = document.getElementById("legendContainer");
    el.innerHTML = types
      .map(
        t => `
      <div class="legend-item">
        <span class="legend-dot" style="background:${t.color}"></span>
        ${t.label}
      </div>`
      )
      .join("");
  }

  function openDetail(date, list) {
    const days = ["日", "月", "火", "水", "木", "金", "土"];
    document.getElementById("detailDateStr").textContent =
      `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日 (${days[date.getDay()]})`;

    const nth = Math.floor((date.getDate() - 1) / 7) + 1;
    document.getElementById("detailMetaStr").textContent = `第${nth}週目`;

    const container = document.getElementById("detailList");
    if (!list.length) {
      container.innerHTML =
        `<div class="detail-empty"><i class="fa-regular fa-face-smile"></i><br>回収予定はありません</div>`;
    } else {
      container.innerHTML = list
        .map(
          g => `
        <div class="detail-item" style="border-left-color:${g.color}; border-left-width:4px;">
          <div class="detail-icon" style="background:${g.bgColor}; color:${g.textColor};">
            <i class="fa-solid ${g.icon}"></i>
          </div>
          <div class="detail-name">${g.label}</div>
        </div>`
        )
        .join("");
    }
    toggleModal("detailModal", true);
  }

  function slugify(name) {
    return name
      .trim()
      .toLowerCase()
      .replace(/[^\p{L}\p{N}]+/gu, "-")
      .replace(/^-+|-+$/g, "") || "cat";
  }

  function addCategory() {
    const name = prompt("新しいごみ分類の名前を入力してください：");
    if (!name || !name.trim()) return;
    const trimmed = name.trim();

    let baseId = slugify(trimmed);
    let id = baseId;
    let idx = 1;
    while (types.some(t => t.id === id)) {
      id = `${baseId}-${idx++}`;
    }

    const palette = COLOR_PALETTE[types.length % COLOR_PALETTE.length];
    const newType = {
      id,
      label: trimmed,
      color: palette.color,
      bgColor: palette.bgColor,
      textColor: palette.textColor,
      icon: "fa-trash-can"
    };

    types.push(newType);
    rules[id] = { mode: "off", weekdays: [], nth: [] };
    persistState();
    renderSettingsUI();
    renderCalendar();
    renderLegend();
  }

  function deleteCategory(id) {
    if (types.length <= 1) {
      alert("少なくとも1つの分類が必要です。");
      return;
    }
    const t = types.find(x => x.id === id);
    const name = t ? t.label : id;
    if (!confirm(`「${name}」を削除しますか？`)) return;

    types = types.filter(x => x.id !== id);
    delete rules[id];
    persistState();
    renderSettingsUI();
    renderCalendar();
    renderLegend();
  }

  function resetAll() {
    if (!confirm("全ての分類と収集ルールを初期状態に戻しますか？")) return;
    const state = createDefaultState();
    types = state.types;
    rules = state.rules;
    localStorage.removeItem(STORAGE_KEY);
    renderSettingsUI();
    renderCalendar();
    renderLegend();
  }

  function renderSettingsUI() {
    const container = document.getElementById("settingsList");
    container.innerHTML = "";

    const dayLabels = ["日", "月", "火", "水", "木", "金", "土"];

    types.forEach(type => {
      const rule = rules[type.id];
      const wrapper = document.createElement("div");
      wrapper.className = "setting-group";
      wrapper.dataset.id = type.id;

      // 無効判定
      const disabled =
        rule.mode === "off" ||
        rule.weekdays.length === 0 ||
        (rule.mode === "nth" && rule.nth.length === 0);

      const disabledBadge = disabled ? '<span class="badge-muted">無効</span>' : "";

      wrapper.innerHTML = `
        <div class="setting-header">
          <div class="setting-title">
            <div class="setting-indicator" style="background:${type.color}"></div>
            ${type.label}
          </div>
          <div style="display:flex;align-items:center;gap:6px;">
            ${disabledBadge}
            <button class="delete-type-btn" type="button" title="削除" data-delete="${type.id}">
              <i class="fa-solid fa-trash-can"></i>
            </button>
          </div>
        </div>
        <div class="mode-selector">
          <div class="mode-option ${rule.mode === "weekly" ? "active" : ""}" data-mode="weekly">毎週</div>
          <div class="mode-option ${rule.mode === "nth" ? "active" : ""}" data-mode="nth">隔週・指定週</div>
          <div class="mode-option ${rule.mode === "off" ? "active" : ""}" data-mode="off">なし</div>
        </div>
        <div class="options-container ${rule.mode === "off" ? "hidden" : ""}">
          <div style="font-size:12px;color:var(--text-sub);margin-bottom:4px;">曜日:</div>
          <div class="week-selector">
            ${[0,1,2,3,4,5,6].map(d => `
              <div class="toggle-btn ${rule.weekdays.includes(d) ? "active" : ""}" data-day="${d}">
                ${dayLabels[d]}
              </div>`).join("")}
          </div>
          <div class="nth-wrapper ${rule.mode !== "nth" ? "hidden" : ""}" style="margin-top:10px;">
            <div style="font-size:12px;color:var(--text-sub);margin-bottom:4px;">対象週:</div>
            <div class="nth-selector">
              ${[1,2,3,4,5].map(n => `
                <div class="toggle-btn ${rule.nth.includes(n) ? "active" : ""}" data-nth="${n}">
                  第${n}
                </div>`).join("")}
            </div>
          </div>
        </div>
      `;

      wrapper.querySelector("[data-delete]").addEventListener("click", () => deleteCategory(type.id));

      wrapper.querySelectorAll(".mode-option").forEach(btn => {
        btn.addEventListener("click", () => {
          const mode = btn.dataset.mode;
          rules[type.id].mode = mode;
          persistState();
          renderSettingsUI();
        });
      });

      wrapper.querySelectorAll("[data-day]").forEach(btn => {
        btn.addEventListener("click", () => {
          const day = Number(btn.dataset.day);
          const arr = rules[type.id].weekdays;
          const idx = arr.indexOf(day);
          if (idx >= 0) arr.splice(idx, 1); else arr.push(day);
          persistState();
          renderSettingsUI();
        });
      });

      wrapper.querySelectorAll("[data-nth]").forEach(btn => {
        btn.addEventListener("click", () => {
          const n = Number(btn.dataset.nth);
          const arr = rules[type.id].nth;
          const idx = arr.indexOf(n);
          if (idx >= 0) arr.splice(idx, 1); else arr.push(n);
          persistState();
          renderSettingsUI();
        });
      });

      container.appendChild(wrapper);
    });
  }

  function toggleModal(id, show) {
    const el = document.getElementById(id);
    if (!el) return;
    if (show) el.classList.add("active");
    else el.classList.remove("active");
  }

  init();
</script>
</body>
</html>

