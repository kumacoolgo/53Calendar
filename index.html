<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8" />
  <title>ごみ収集日カレンダー</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">

  <style>
    :root {
      --bg: #f3f4f6;
      --card-bg: #ffffff;
      --accent: #10b981;
      --border: #e5e7eb;
      --text-main: #111827;
      --text-muted: #6b7280;
    }

    * { box-sizing: border-box; }

    body {
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      margin: 0;
      padding: 12px;
      background: radial-gradient(circle at top, #e0f2fe, #f9fafb 50%, #e5e7eb 100%);
      color: var(--text-main);
    }

    .app {
      max-width: 960px;
      margin: 0 auto;
      background: var(--card-bg);
      padding: 14px 14px 18px;
      border-radius: 16px;
      box-shadow:
        0 18px 40px rgba(15, 23, 42, 0.15),
        0 0 0 1px rgba(148, 163, 184, 0.25);
    }

    .calendar-header {
      display: flex;
      align-items: center;
      justify-content: space-between;
      margin-bottom: 10px;
      gap: 8px;
      flex-wrap: wrap;
    }

    .calendar-header-left,
    .calendar-header-right {
      display: flex;
      align-items: center;
      gap: 8px;
    }

    .btn {
      cursor: pointer;
      border-radius: 999px;
      border: 1px solid #d1d5db;
      padding: 6px 12px;
      background: #f9fafb;
      font-size: 13px;
      display: inline-flex;
      align-items: center;
      gap: 4px;
      transition: background 0.15s, box-shadow 0.15s, transform 0.05s;
      -webkit-tap-highlight-color: transparent;
    }
    .btn:active {
      transform: translateY(1px);
      box-shadow: inset 0 1px 2px rgba(0,0,0,0.12);
    }
    .btn:hover { background: #edf2ff; }

    .btn-primary {
      background: var(--accent);
      border-color: #059669;
      color: #ecfdf5;
      font-weight: 500;
    }
    .btn-primary:hover { background: #059669; }

    #monthLabel {
      font-weight: 700;
      font-size: 18px;
      letter-spacing: 0.04em;
    }

    .calendar-wrapper {
      overflow-x: auto;
      border-radius: 12px;
      border: 1px solid var(--border);
      background: #f9fafb;
    }

    table.calendar {
      width: 100%;
      border-collapse: collapse;
      table-layout: fixed;
      font-size: 12px;
      min-width: 600px; /* 手机太窄时可以左右滑动 */
    }

    .calendar th,
    .calendar td {
      border: 1px solid #e5e7eb;
      height: 80px;
      vertical-align: top;
      position: relative;
      padding: 4px 4px 4px 6px;
      background: #ffffff;
    }

    .calendar th {
      background: #f3f4f6;
      font-weight: 600;
      font-size: 11px;
      text-align: center;
      padding: 6px 0;
    }

    .calendar th.sun,
    .calendar td.sun { color: #dc2626; }
    .calendar th.sat,
    .calendar td.sat { color: #2563eb; }

    .calendar td {
      cursor: pointer;
      touch-action: manipulation;
      transition: background 0.12s, box-shadow 0.12s;
    }
    .calendar td:hover { background: #eff6ff; }
    .calendar td:active {
      background: #dbeafe;
      box-shadow: inset 0 0 0 1px #93c5fd;
    }

    /* 今天高亮：黄色背景 + 边框 */
    .calendar td.today {
      background: #fef9c3;
      box-shadow: inset 0 0 0 2px #facc15;
      position: relative;
    }
    .calendar td.today:hover {
      background: #fef3c7;
    }

    .date-number {
      position: absolute;
      right: 5px;
      top: 4px;
      font-size: 11px;
      font-weight: 500;
    }

    .labels {
      margin-top: 18px;
      display: flex;
      flex-direction: column;
      gap: 3px;
      font-size: 10px;
    }

    .label {
      border-radius: 999px;
      padding: 2px 6px;
      line-height: 1.2;
      word-break: break-all;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      border: 1px solid rgba(148, 163, 184, 0.4);
    }

    .label-burnable       { background: #fee2e2; }
    .label-nonburnable    { background: #fef3c7; }
    .label-plastic        { background: #dbeafe; }
    .label-paper          { background: #fef9c3; }
    .label-pet            { background: #dcfce7; }
    .label-tray           { background: #e0e7ff; }
    .label-cloth          { background: #fae8ff; }

    .legend {
      margin-top: 10px;
      display: flex;
      flex-wrap: wrap;
      gap: 6px;
      font-size: 10px;
      color: var(--text-muted);
    }
    .legend-item {
      display: inline-flex;
      align-items: center;
      gap: 4px;
      padding: 2px 6px;
      border-radius: 999px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
    }
    .legend-color {
      width: 10px;
      height: 10px;
      border-radius: 999px;
    }

    /* 通用浮层（设置 & 每日详情） */
    .overlay {
      position: fixed;
      inset: 0;
      background: rgba(15, 23, 42, 0.35);
      display: none;
      align-items: center;
      justify-content: center;
      z-index: 100;
      padding: 16px;
    }

    .panel {
      background: #ffffff;
      max-width: 720px;
      width: 100%;
      max-height: 90vh;
      border-radius: 16px;
      padding: 16px 14px 14px;
      box-shadow:
        0 24px 60px rgba(15, 23, 42, 0.45),
        0 0 0 1px rgba(148, 163, 184, 0.6);
      overflow: auto;
      font-size: 13px;
    }

    .panel h2 {
      margin: 0 0 6px;
      font-size: 16px;
    }

    .panel small { color: var(--text-muted); }

    #settingsTable {
      width: 100%;
      border-collapse: collapse;
      margin-top: 10px;
      font-size: 12px;
    }

    #settingsTable th,
    #settingsTable td {
      border: 1px solid #e5e7eb;
      padding: 4px;
      vertical-align: top;
      background: #ffffff;
    }

    #settingsTable th {
      background: #f3f4f6;
      font-weight: 600;
    }

    .weekday-group label,
    .nth-group label {
      margin-right: 4px;
      white-space: nowrap;
      display: inline-block;
    }

    .settings-footer {
      margin-top: 12px;
      display: flex;
      justify-content: flex-end;
      gap: 8px;
    }

    /* 每日详情弹窗样式 */
    #dayTitle {
      font-size: 16px;
      margin-bottom: 8px;
    }

    #daySubtitle {
      font-size: 12px;
      color: var(--text-muted);
      margin-bottom: 8px;
    }

    #dayList {
      display: flex;
      flex-direction: column;
      gap: 6px;
      margin-top: 4px;
      margin-bottom: 10px;
    }

    .day-item {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 8px;
      padding: 6px 8px;
      border-radius: 10px;
      background: #f9fafb;
      border: 1px solid #e5e7eb;
      font-size: 13px;
    }

    .day-item-label { font-weight: 500; }

    .day-item-tag {
      font-size: 11px;
      color: var(--text-muted);
    }

    .day-empty {
      padding: 8px 10px;
      border-radius: 10px;
      background: #f9fafb;
      border: 1px dashed #d1d5db;
      font-size: 13px;
      color: var(--text-muted);
    }

    .panel-footer {
      display: flex;
      justify-content: flex-end;
      gap: 8px;
      margin-top: 10px;
    }

    @media (max-width: 640px) {
      body { padding: 8px; }
      .app {
        padding: 12px 10px 14px;
        border-radius: 14px;
        box-shadow:
          0 10px 30px rgba(15, 23, 42, 0.2),
          0 0 0 1px rgba(148, 163, 184, 0.45);
      }
      #monthLabel { font-size: 17px; }
      table.calendar { font-size: 11px; }
      .calendar th,
      .calendar td { height: 72px; }
      .labels { font-size: 9px; }
      .panel {
        max-width: 100%;
        padding: 14px 12px 12px;
        border-radius: 14px;
      }
    }
  </style>
</head>
<body>
<div class="app">
  <div class="calendar-header">
    <div class="calendar-header-left">
      <button class="btn" id="prevMonth">＜</button>
      <span id="monthLabel"></span>
      <button class="btn" id="nextMonth">＞</button>
    </div>
    <div class="calendar-header-right">
      <button class="btn btn-primary" id="openSettings">設定</button>
    </div>
  </div>

  <div class="calendar-wrapper">
    <table class="calendar">
      <thead>
      <tr>
        <th class="sun">日</th>
        <th>月</th>
        <th>火</th>
        <th>水</th>
        <th>木</th>
        <th>金</th>
        <th class="sat">土</th>
      </tr>
      </thead>
      <tbody id="calendarBody">
      <!-- JS 生成 -->
      </tbody>
    </table>
  </div>

  <!-- 颜色说明 -->
  <div class="legend">
    <div class="legend-item">
      <span class="legend-color" style="background:#fee2e2"></span><span>燃やすごみ</span>
    </div>
    <div class="legend-item">
      <span class="legend-color" style="background:#fef3c7"></span><span>燃やさないごみ</span>
    </div>
    <div class="legend-item">
      <span class="legend-color" style="background:#dbeafe"></span><span>プラスチック</span>
    </div>
    <div class="legend-item">
      <span class="legend-color" style="background:#fef9c3"></span><span>古紙・びん・缶</span>
    </div>
    <div class="legend-item">
      <span class="legend-color" style="background:#dcfce7"></span><span>ペットボトル</span>
    </div>
    <div class="legend-item">
      <span class="legend-color" style="background:#e0e7ff"></span><span>発泡トレイ</span>
    </div>
    <div class="legend-item">
      <span class="legend-color" style="background:#fae8ff"></span><span>古布</span>
    </div>
  </div>
</div>

<!-- 设置弹窗 -->
<div class="overlay" id="settingsOverlay">
  <div class="panel">
    <h2>収集日設定</h2>
    <small>※「毎週」はチェックされた曜日すべてが収集日になります。「第○」を選ぶと、チェックした週だけ収集されます。</small>

    <table id="settingsTable">
      <thead>
      <tr>
        <th style="width: 120px;">ごみの種類</th>
        <th>収集ルール</th>
      </tr>
      </thead>
      <tbody>
      <tr data-id="burnable">
        <td>燃やすごみ</td>
        <td>
          <div>
            モード：
            <select class="mode">
              <option value="weekly">毎週</option>
              <option value="nth">第○週のみ</option>
              <option value="off">収集なし</option>
            </select>
          </div>
          <div>
            曜日：
            <span class="weekday-group">
              <label><input type="checkbox" value="0">日</label>
              <label><input type="checkbox" value="1">月</label>
              <label><input type="checkbox" value="2">火</label>
              <label><input type="checkbox" value="3">水</label>
              <label><input type="checkbox" value="4">木</label>
              <label><input type="checkbox" value="5">金</label>
              <label><input type="checkbox" value="6">土</label>
            </span>
          </div>
          <div>
            週：
            <span class="nth-group">
              <label><input type="checkbox" value="1">第1</label>
              <label><input type="checkbox" value="2">第2</label>
              <label><input type="checkbox" value="3">第3</label>
              <label><input type="checkbox" value="4">第4</label>
              <label><input type="checkbox" value="5">第5</label>
            </span>
          </div>
        </td>
      </tr>

      <tr data-id="nonburnable">
        <td>燃やさないごみ</td>
        <td>
          <div>
            モード：
            <select class="mode">
              <option value="weekly">毎週</option>
              <option value="nth">第○週のみ</option>
              <option value="off">収集なし</option>
            </select>
          </div>
          <div>
            曜日：
            <span class="weekday-group">
              <label><input type="checkbox" value="0">日</label>
              <label><input type="checkbox" value="1">月</label>
              <label><input type="checkbox" value="2">火</label>
              <label><input type="checkbox" value="3">水</label>
              <label><input type="checkbox" value="4">木</label>
              <label><input type="checkbox" value="5">金</label>
              <label><input type="checkbox" value="6">土</label>
            </span>
          </div>
          <div>
            週：
            <span class="nth-group">
              <label><input type="checkbox" value="1">第1</label>
              <label><input type="checkbox" value="2">第2</label>
              <label><input type="checkbox" value="3">第3</label>
              <label><input type="checkbox" value="4">第4</label>
              <label><input type="checkbox" value="5">第5</label>
            </span>
          </div>
        </td>
      </tr>

      <tr data-id="plastic">
        <td>プラスチック</td>
        <td>
          <div>
            モード：
            <select class="mode">
              <option value="weekly">毎週</option>
              <option value="nth">第○週のみ</option>
              <option value="off">収集なし</option>
            </select>
          </div>
          <div>
            曜日：
            <span class="weekday-group">
              <label><input type="checkbox" value="0">日</label>
              <label><input type="checkbox" value="1">月</label>
              <label><input type="checkbox" value="2">火</label>
              <label><input type="checkbox" value="3">水</label>
              <label><input type="checkbox" value="4">木</label>
              <label><input type="checkbox" value="5">金</label>
              <label><input type="checkbox" value="6">土</label>
            </span>
          </div>
          <div>
            週：
            <span class="nth-group">
              <label><input type="checkbox" value="1">第1</label>
              <label><input type="checkbox" value="2">第2</label>
              <label><input type="checkbox" value="3">第3</label>
              <label><input type="checkbox" value="4">第4</label>
              <label><input type="checkbox" value="5">第5</label>
            </span>
          </div>
        </td>
      </tr>

      <tr data-id="paper">
        <td>古紙・びん・缶</td>
        <td>
          <div>
            モード：
            <select class="mode">
              <option value="weekly">毎週</option>
              <option value="nth">第○週のみ</option>
              <option value="off">収集なし</option>
            </select>
          </div>
          <div>
            曜日：
            <span class="weekday-group">
              <label><input type="checkbox" value="0">日</label>
              <label><input type="checkbox" value="1">月</label>
              <label><input type="checkbox" value="2">火</label>
              <label><input type="checkbox" value="3">水</label>
              <label><input type="checkbox" value="4">木</label>
              <label><input type="checkbox" value="5">金</label>
              <label><input type="checkbox" value="6">土</label>
            </span>
          </div>
          <div>
            週：
            <span class="nth-group">
              <label><input type="checkbox" value="1">第1</label>
              <label><input type="checkbox" value="2">第2</label>
              <label><input type="checkbox" value="3">第3</label>
              <label><input type="checkbox" value="4">第4</label>
              <label><input type="checkbox" value="5">第5</label>
            </span>
          </div>
        </td>
      </tr>

      <tr data-id="pet">
        <td>ペットボトル</td>
        <td>
          <div>
            モード：
            <select class="mode">
              <option value="weekly">毎週</option>
              <option value="nth">第○週のみ</option>
              <option value="off">収集なし</option>
            </select>
          </div>
          <div>
            曜日：
            <span class="weekday-group">
              <label><input type="checkbox" value="0">日</label>
              <label><input type="checkbox" value="1">月</label>
              <label><input type="checkbox" value="2">火</label>
              <label><input type="checkbox" value="3">水</label>
              <label><input type="checkbox" value="4">木</label>
              <label><input type="checkbox" value="5">金</label>
              <label><input type="checkbox" value="6">土</label>
            </span>
          </div>
          <div>
            週：
            <span class="nth-group">
              <label><input type="checkbox" value="1">第1</label>
              <label><input type="checkbox" value="2">第2</label>
              <label><input type="checkbox" value="3">第3</label>
              <label><input type="checkbox" value="4">第4</label>
              <label><input type="checkbox" value="5">第5</label>
            </span>
          </div>
        </td>
      </tr>

      <tr data-id="tray">
        <td>発泡スチロール製食品用トレイ</td>
        <td>
          <div>
            モード：
            <select class="mode">
              <option value="weekly">毎週</option>
              <option value="nth">第○週のみ</option>
              <option value="off">収集なし</option>
            </select>
          </div>
          <div>
            曜日：
            <span class="weekday-group">
              <label><input type="checkbox" value="0">日</label>
              <label><input type="checkbox" value="1">月</label>
              <label><input type="checkbox" value="2">火</label>
              <label><input type="checkbox" value="3">水</label>
              <label><input type="checkbox" value="4">木</label>
              <label><input type="checkbox" value="5">金</label>
              <label><input type="checkbox" value="6">土</label>
            </span>
          </div>
          <div>
            週：
            <span class="nth-group">
              <label><input type="checkbox" value="1">第1</label>
              <label><input type="checkbox" value="2">第2</label>
              <label><input type="checkbox" value="3">第3</label>
              <label><input type="checkbox" value="4">第4</label>
              <label><input type="checkbox" value="5">第5</label>
            </span>
          </div>
        </td>
      </tr>

      <tr data-id="cloth">
        <td>古布</td>
        <td>
          <div>
            モード：
            <select class="mode">
              <option value="weekly">毎週</option>
              <option value="nth">第○週のみ</option>
              <option value="off">収集なし</option>
            </select>
          </div>
          <div>
            曜日：
            <span class="weekday-group">
              <label><input type="checkbox" value="0">日</label>
              <label><input type="checkbox" value="1">月</label>
              <label><input type="checkbox" value="2">火</label>
              <label><input type="checkbox" value="3">水</label>
              <label><input type="checkbox" value="4">木</label>
              <label><input type="checkbox" value="5">金</label>
              <label><input type="checkbox" value="6">土</label>
            </span>
          </div>
          <div>
            週：
            <span class="nth-group">
              <label><input type="checkbox" value="1">第1</label>
              <label><input type="checkbox" value="2">第2</label>
              <label><input type="checkbox" value="3">第3</label>
              <label><input type="checkbox" value="4">第4</label>
              <label><input type="checkbox" value="5">第5</label>
            </span>
          </div>
        </td>
      </tr>

      </tbody>
    </table>

    <div class="settings-footer">
      <button class="btn" id="closeSettings">キャンセル</button>
      <button class="btn btn-primary" id="saveSettings">保存</button>
    </div>
  </div>
</div>

<!-- 每日详情弹窗 -->
<div class="overlay" id="dayOverlay">
  <div class="panel">
    <h2 id="dayTitle"></h2>
    <div id="daySubtitle"></div>
    <div id="dayList"></div>
    <div class="panel-footer">
      <button class="btn btn-primary" id="closeDay">OK</button>
    </div>
  </div>
</div>

<script>
  // ====== 设置相关 ======
  const STORAGE_KEY = "gomi-settings-v1";

  const defaultSettings = {
    burnable:    { mode: "weekly", weekdays: [3, 6], nth: [] },      // 燃やすごみ　毎週 水・土
    nonburnable: { mode: "nth",    weekdays: [1],    nth: [1, 3] },  // 燃やさないごみ　1・3 月
    plastic:     { mode: "weekly", weekdays: [2],    nth: [] },      // プラスチック　毎週 火
    paper:       { mode: "nth",    weekdays: [2],    nth: [2, 4] },  // 古紙・びん・缶　第2・第4 火
    pet:         { mode: "weekly", weekdays: [5],    nth: [] },      // ペットボトル　毎週 金
    tray:        { mode: "weekly", weekdays: [5],    nth: [] },      // 発泡トレイ　毎週 金
    cloth:       { mode: "weekly", weekdays: [5],    nth: [] }       // 古布　毎週 金
  };

  function loadSettings() {
    try {
      const raw = localStorage.getItem(STORAGE_KEY);
      if (raw) {
        const parsed = JSON.parse(raw);
        return { ...defaultSettings, ...parsed };
      }
    } catch (e) {
      console.warn("failed to load settings", e);
    }
    return { ...defaultSettings };
  }

  let settings = loadSettings();

  function saveSettingsToStorage() {
    try {
      localStorage.setItem(STORAGE_KEY, JSON.stringify(settings));
    } catch (e) {
      console.warn("failed to save settings", e);
    }
  }

  // ====== 垃圾类型定义 ======
  const garbageTypes = [
    { id: "burnable",    label: "燃やすごみ",       css: "label-burnable" },
    { id: "nonburnable", label: "燃やさないごみ",   css: "label-nonburnable" },
    { id: "plastic",     label: "プラスチック",     css: "label-plastic" },
    { id: "paper",       label: "古紙・びん・缶",   css: "label-paper" },
    { id: "pet",         label: "ペットボトル",     css: "label-pet" },
    { id: "tray",        label: "発泡スチロール製食品用トレイ", css: "label-tray" },
    { id: "cloth",       label: "古布",             css: "label-cloth" }
  ];

  // ====== 今天（用于 Today 高亮） ======
  const today = new Date();
  const TODAY_YEAR  = today.getFullYear();
  const TODAY_MONTH = today.getMonth();   // 0-11
  const TODAY_DATE  = today.getDate();

  // ====== 收集日判断 ======
  function isCollectionDay(date, rule) {
    if (!rule || rule.mode === "off") return false;

    const weekday = date.getDay();
    if (!rule.weekdays || rule.weekdays.length === 0) return false;
    if (!rule.weekdays.includes(weekday)) return false;

    if (rule.mode === "weekly") return true;

    if (rule.mode === "nth") {
      const nth = Math.floor((date.getDate() - 1) / 7) + 1;
      if (!rule.nth || rule.nth.length === 0) return false;
      return rule.nth.includes(nth);
    }
    return false;
  }

  function getGarbageForDate(date) {
    const list = [];
    for (const g of garbageTypes) {
      const rule = settings[g.id];
      if (isCollectionDay(date, rule)) {
        list.push({ ...g });
      }
    }
    return list;
  }

  // ====== 日历 ======
  let current = new Date(); // 打开时默认当月

  const calendarBody = document.getElementById("calendarBody");
  const monthLabel = document.getElementById("monthLabel");

  function renderCalendar() {
    const year = current.getFullYear();
    const month = current.getMonth();

    monthLabel.textContent = `${year}年${month + 1}月`;

    calendarBody.innerHTML = "";

    const firstDay = new Date(year, month, 1);
    const lastDay  = new Date(year, month + 1, 0);
    const startWeekday = firstDay.getDay();
    const totalDays    = lastDay.getDate();

    let row = document.createElement("tr");
    let colIndex = 0;

    // 前置空格
    for (let i = 0; i < startWeekday; i++) {
      const td = document.createElement("td");
      if (colIndex === 0) td.classList.add("sun");
      if (colIndex === 6) td.classList.add("sat");
      row.appendChild(td);
      colIndex++;
    }

    for (let day = 1; day <= totalDays; day++) {
      if (colIndex === 7) {
        calendarBody.appendChild(row);
        row = document.createElement("tr");
        colIndex = 0;
      }

      const td = document.createElement("td");
      if (colIndex === 0) td.classList.add("sun");
      if (colIndex === 6) td.classList.add("sat");

      const date = new Date(year, month, day);

      // Today 高亮
      if (
        year  === TODAY_YEAR &&
        month === TODAY_MONTH &&
        day   === TODAY_DATE
      ) {
        td.classList.add("today");
      }

      const num = document.createElement("div");
      num.className = "date-number";
      num.textContent = day;
      td.appendChild(num);

      const labelsWrapper = document.createElement("div");
      labelsWrapper.className = "labels";

      const gomiList = getGarbageForDate(date);
      gomiList.forEach(g => {
        const div = document.createElement("div");
        div.className = "label " + g.css;
        div.textContent = g.label;
        labelsWrapper.appendChild(div);
      });

      if (gomiList.length > 0) {
        td.appendChild(labelsWrapper);
      }

      // 点击某一天 -> 弹出详情
      td.addEventListener("click", () => {
        openDayModal(date, gomiList);
      });

      row.appendChild(td);
      colIndex++;
    }

    // 收尾补齐
    while (colIndex > 0 && colIndex < 7) {
      const td = document.createElement("td");
      if (colIndex === 0) td.classList.add("sun");
      if (colIndex === 6) td.classList.add("sat");
      row.appendChild(td);
      colIndex++;
    }
    calendarBody.appendChild(row);
  }

  // 月份切换
  document.getElementById("prevMonth").addEventListener("click", () => {
    current.setMonth(current.getMonth() - 1);
    renderCalendar();
  });
  document.getElementById("nextMonth").addEventListener("click", () => {
    current.setMonth(current.getMonth() + 1);
    renderCalendar();
  });

  // ====== 设置弹窗逻辑 ======
  const settingsOverlay = document.getElementById("settingsOverlay");
  document.getElementById("openSettings").addEventListener("click", () => {
    populateSettingsForm();
    settingsOverlay.style.display = "flex";
  });
  document.getElementById("closeSettings").addEventListener("click", () => {
    settingsOverlay.style.display = "none";
  });
  settingsOverlay.addEventListener("click", e => {
    if (e.target === settingsOverlay) settingsOverlay.style.display = "none";
  });

  function populateSettingsForm() {
    const rows = document.querySelectorAll("#settingsTable tbody tr");
    rows.forEach(row => {
      const id = row.dataset.id;
      const rule = settings[id];
      if (!rule) return;

      row.querySelector(".mode").value = rule.mode;

      const weekdayChecks = row.querySelectorAll(".weekday-group input[type=checkbox]");
      weekdayChecks.forEach(cb => {
        cb.checked = rule.weekdays.includes(Number(cb.value));
      });

      const nthChecks = row.querySelectorAll(".nth-group input[type=checkbox]");
      nthChecks.forEach(cb => {
        cb.checked = rule.nth.includes(Number(cb.value));
      });
    });
  }

  document.getElementById("saveSettings").addEventListener("click", () => {
    const rows = document.querySelectorAll("#settingsTable tbody tr");
    rows.forEach(row => {
      const id = row.dataset.id;
      const mode = row.querySelector(".mode").value;

      const weekdays = [];
      row.querySelectorAll(".weekday-group input[type=checkbox]:checked")
        .forEach(cb => weekdays.push(Number(cb.value)));

      const nth = [];
      row.querySelectorAll(".nth-group input[type=checkbox]:checked")
        .forEach(cb => nth.push(Number(cb.value)));

      settings[id] = { mode, weekdays, nth };
    });

    saveSettingsToStorage();
    settingsOverlay.style.display = "none";
    renderCalendar();
  });

  // ====== 每日详情弹窗 ======
  const dayOverlay  = document.getElementById("dayOverlay");
  const dayTitle    = document.getElementById("dayTitle");
  const daySubtitle = document.getElementById("daySubtitle");
  const dayList     = document.getElementById("dayList");
  const closeDay    = document.getElementById("closeDay");

  function openDayModal(date, gomiList) {
    const y = date.getFullYear();
    const m = date.getMonth() + 1;
    const d = date.getDate();
    const weekdayNames = ["日", "月", "火", "水", "木", "金", "土"];

    dayTitle.textContent = `${y}年${m}月${d}日（${weekdayNames[date.getDay()]}）`;

    const nth = Math.floor((d - 1) / 7) + 1;
    daySubtitle.textContent = `第${nth}週目`;

    dayList.innerHTML = "";

    if (!gomiList || gomiList.length === 0) {
      const empty = document.createElement("div");
      empty.className = "day-empty";
      empty.textContent = "この日は収集予定はありません。";
      dayList.appendChild(empty);
    } else {
      gomiList.forEach(g => {
        const item = document.createElement("div");
        item.className = "day-item";

        const left = document.createElement("div");
        left.className = "day-item-label";
        left.textContent = g.label;

        const tag = document.createElement("span");
        tag.className = "day-item-tag";
        tag.textContent = "ごみ出し日";

        item.appendChild(left);
        item.appendChild(tag);

        item.style.borderLeft = "4px solid";
        switch (g.id) {
          case "burnable":    item.style.borderLeftColor = "#f97373"; break;
          case "nonburnable": item.style.borderLeftColor = "#facc15"; break;
          case "plastic":     item.style.borderLeftColor = "#60a5fa"; break;
          case "paper":       item.style.borderLeftColor = "#eab308"; break;
          case "pet":         item.style.borderLeftColor = "#22c55e"; break;
          case "tray":        item.style.borderLeftColor = "#4f46e5"; break;
          case "cloth":       item.style.borderLeftColor = "#d946ef"; break;
        }

        dayList.appendChild(item);
      });
    }

    dayOverlay.style.display = "flex";
  }

  closeDay.addEventListener("click", () => {
    dayOverlay.style.display = "none";
  });
  dayOverlay.addEventListener("click", e => {
    if (e.target === dayOverlay) dayOverlay.style.display = "none";
  });

  // ====== 初始渲染（默认今天所在的月份） ======
  renderCalendar();
</script>
</body>
</html>
